/**
 * @file s21_tetris.h
 * @brief Публичный интерфейс игры Тетрис для интеграции в движок BrickGame
 *
 * Определяет API игры Тетрис, включающий функции управления жизненным циклом,
 * обработки ввода, игрового обновления и получения состояния. Использует
 * принцип инкапсуляции: внутренняя реализация скрыта за абстрактным типом
 * void*. Обеспечивает совместимость с общим движком игр через шаблон
 * GameInterface_t.
 *
 * @details Основные функции:
 * - tetris_create() / tetris_destroy() — создание и уничтожение экземпляра
 * - tetris_handle_input() — реакция на действия пользователя
 * - tetris_update() — обработка игрового таймера (тик)
 * - tetris_get_info() — получение текущего состояния для отрисовки
 * - tetris_get_interface() — интеграция в общий движок игр
 *
 * @note Все функции работают с конечным автоматом (FSM), обеспечивающим
 *       корректную смену состояний игры (пауза, игра, проигрыш и т.д.).
 *       Скорость и сложность увеличиваются с ростом уровня.
 *
 * @warning Использование указателя void* отсутствует — тип TetrisGame является
 *          неполным типом, обеспечивающим типобезопасность и инкапсуляцию.
 *
 * @author provemet
 * @version 2.2
 * @date 2025-12-18
 * @see s21_tetris.c, s21_tetris_internals.h
 */
#ifndef S21_TETRIS_H_
#define S21_TETRIS_H_

#include "s21_bgame.h"  // GameInfo_t, UserAction_t, GameId_t, GameInterface_t
#include "s21_tetris_internals.h"

#ifdef __cplusplus
extern "C" {
#endif

/**
 * @brief Создаёт и инициализирует новый экземпляр игры Тетрис
 *
 * Функция выделяет и инициализирует объект игры, включая игровое поле,
 * статистику, FSM (конечный автомат), текущую и следующую фигуры. Используется
 * как точка входа в публичный API игры. Возвращает абстрактный указатель для
 * соблюдения принципа инкапсуляции.
 *
 * @return Указатель на вновь созданный экземпляр игры. Тип — void*, чтобы
 * скрыть внутреннюю реализацию от внешнего кода. В случае ошибки выделения
 * памяти или сбоя инициализации возвращается NULL.
 *
 * @details
 * Процесс создания включает:
 * - Выделение памяти под структуру TetrisGame
 * - Инициализацию игрового поля (очистка)
 * - Генерацию начальных фигур (текущей и следующей)
 * - Установку нулевого счёта, уровня и рекорда
 * - Инициализацию конечного автомата (FSM) в состояние TETRIS_STATE_INIT
 *
 * @note Функция является потоконебезопасной. Не вызывайте её одновременно
 *       из нескольких потоков с использованием общих данных.
 *
 * @warning Результат должен быть освобождён с помощью tetris_destroy() после
 *          завершения работы с игрой. Игнорирование этого правила приведёт
 *          к утечке памяти. Не передавайте возвращённый указатель в функции,
 *          ожидающие другой тип — поведение не определено.
 *
 * @see tetris_destroy(), tetris_game_create(), tetris_update(),
 * tetris_get_info()
 */
void *tetris_create(void);

/**
 * @brief Освобождает ресурсы, связанные с экземпляром игры Тетрис
 *
 * Функция корректно завершает работу с объектом игры: освобождает динамически
 * выделенную память, уничтожает внутренние структуры данных, включая игровое
 * поле, фигуры, состояния FSM и сопутствующие буферы. После вызова указатель
 * становится недействительным.
 *
 * @param[in] game Указатель на экземпляр игры, полученный через
 * tetris_create(). Допускается передача NULL — в этом случае функция не
 * выполняет никаких действий.
 *
 * @details
 * Освобождение включает:
 * - Уничтожение объекта TetrisGame
 * - Очистку внутреннего хранилища поля (field_storage)
 * - Освобождение ресурсов, связанных с FSM (если требуется)
 * - Сохранение рекорда в хранилище (опционально, зависит от реализации)
 *
 * Функция является безопасной для повторного вызова с NULL.
 *
 * @note Повторный вызов с уже освобождённым указателем приведёт к
 * неопределённому поведению. Убедитесь, что после вызова tetris_destroy()
 * указатель больше нигде не используется.
 *
 * @warning Не используйте данный указатель после вызова функции. Повторное
 * освобождение одной и той же памяти (double free) вызовет критический сбой
 * программы.
 *
 * @see tetris_create(), tetris_game_destroy(), TetrisGame
 */
void tetris_destroy(void *game);

/**
 * @brief Обрабатывает пользовательский ввод в игре Тетрис
 *
 * Преобразует действия пользователя (нажатие клавиш) в события конечного
 * автомата (FSM), которые затем обрабатываются в соответствии с текущим
 * состоянием игры. Поддерживает как однократные нажатия, так и удержание клавиш
 * (через флаг hold).
 *
 * @param[in] game    Указатель на экземпляр игры, созданный через
 * tetris_create(). Если равен NULL, функция безопасно завершается без
 * выполнения действий.
 * @param[in] action  Тип действия пользователя, заданный перечислением
 * UserAction_t. Допустимые значения:
 *                    - Start:      начать игру или перезапустить после
 * окончания
 *                    - Pause:      приостановить/возобновить игру
 *                    - Terminate:  завершить текущую игру
 *                    - Left:       переместить фигуру влево
 *                    - Right:      переместить фигуру вправо
 *                    - Up:         нет действия (заглушка), оставлено для
 * совместимости
 *                    - Down:       ускорить падение фигуры (вниз)
 *                    - Action:     повернуть фигуру по часовой стрелке
 * @param[in] hold    Флаг удержания клавиши:
 *                    - true:  действие вызвано длительным нажатием (например,
 * ускоренное падение)
 *                    - false: однократное нажатие
 *
 * @details
 * Процесс обработки:
 * 1. Проверка валидности указателя на игру.
 * 2. Преобразование действия пользователя в внутреннее событие FSM с помощью
 *    функции tetris_map_action_to_event(), которая учитывает тип действия и
 * флаг hold.
 * 3. Если событие определено (не TETRIS_EVT_NONE), оно отправляется в FSM через
 * tetris_fsm_dispatch().
 *
 * Примеры:
 * - action=Down, hold=true  → TETRIS_EVT_DROP (жёсткое падение)
 * - action=Down, hold=false → TETRIS_EVT_MOVE_DOWN (шаг вниз)
 * - action=Left             → TETRIS_EVT_MOVE_LEFT
 *
 * @note Функция не блокирует выполнение и предназначена для вызова при каждом
 *       событии ввода из пользовательского интерфейса.
 * @note Функция потоконебезопасна — должна вызываться из того же потока, что и
 * tetris_update().
 *
 * @warning Не передавайте невалидные значения action. Поведение в таких случаях
 * не определено. После вызова tetris_destroy() использование указателя game
 * приведёт к аварийному завершению.
 *
 * @see UserAction_t, tetris_update(), tetris_get_info(), TetrisGame
 */
void tetris_handle_input(void *game, UserAction_t action, bool hold);

/**
 * @brief Обновляет состояние игры Тетрис на один игровой тик
 *
 * Функция вызывается регулярно (по таймеру) для продвижения логики игры во
 * времени. Преобразует временной тик в событие конечного автомата (FSM) —
 * TETRIS_EVT_TICK, которое обрабатывается в соответствии с текущим состоянием
 * игры.
 *
 * @param[in] game Указатель на экземпляр игры, созданный через tetris_create().
 *              Может быть NULL — в этом случае функция безопасно завершается
 * без действий.
 *
 * @details
 * Основные действия при обновлении:
 * - Проверка текущего состояния FSM (игра, пауза, начало, проигрыш и т.д.)
 * - Обработка события TETRIS_EVT_TICK:
 *   - Если игра активна — попытка переместить текущую фигуру вниз
 *   - Проверка столкновений и фиксация фигуры при необходимости
 *   - Очистка заполненных линий, начисление очков, повышение уровня
 *   - Спавн новой фигуры
 *   - Проверка условия окончания игры
 *
 * @note Вызов должен происходить с фиксированной частотой (например, раз в
 * 50–500 мс), чтобы обеспечить плавность игрового процесса. Частота зависит от
 * текущего уровня.
 *
 * @warning Функция не является потокобезопасной. Все вызовы игровых функций
 *          должны происходить из одного потока. Не передавайте невалидный
 * указатель.
 *
 * @see tetris_create(), tetris_handle_input(), tetris_fsm_dispatch(),
 * TETRIS_EVT_TICK
 */
void tetris_update(void *game);

/**
 * @brief Возвращает указатель на актуальное состояние игры для отображения
 *
 * Функция предоставляет доступ к публичной информации о текущем состоянии игры,
 * включая игровое поле, следующую фигуру, счёт, уровень, рекорд и флаг паузы.
 * Данные используются движком отрисовки для построения игрового интерфейса.
 *
 * @param[in] game Указатель на экземпляр игры, полученный через
 * tetris_create(). Если передан NULL, функция возвращает NULL.
 *
 * @return Указатель на константную структуру GameInfo_t, содержащую данные для
 * отрисовки, или NULL, если указатель на игру недействителен.
 *
 * @details
 * Перед возвратом данных вызывается tetris_update_info_view(), которая:
 * - Копирует текущее состояние игрового поля (включая зафиксированные блоки)
 * - Накладывает поверх активную падающую фигуру (если игра не на паузе и не
 * завершена)
 * - Обновляет поля next, score, level, high_score, pause
 *
 * Возвращаемая структура содержит:
 * - field[20][10] — игровое поле (0: пустая ячейка, >0: тип блока/цвет)
 * - next[4][4]   — предпросмотр следующей фигуры
 * - score        — текущий счёт
 * - high_score   — сохранённый рекорд
 * - level        — текущий уровень сложности
 * - speed        — задержка между тиками (в миллисекундах)
 * - pause        — флаг паузы (1 — пауза, 0 — игра активна)
 *
 * @note Указатель остаётся валидным только до следующего вызова
 * tetris_update(), tetris_handle_input() или tetris_destroy(). Не сохраняйте
 * его надолго. Данные не копируются — возвращается ссылка на внутреннее
 * состояние.
 *
 * @warning Не модифицируйте содержимое возвращаемой структуры — это нарушит
 *          целостность игры. Функция не является потокобезопасной.
 *
 * @see GameInfo_t, tetris_update_info_view(), tetris_update(),
 * tetris_handle_input()
 */
const GameInfo_t *tetris_get_info(const void *game);

/**
 * @brief Возвращает интерфейс взаимодействия с игрой "Тетрис" для интеграции в
 * общий игровой движок
 *
 * Функция формирует и возвращает структуру GameInterface_t, содержащую функции
 * управления игрой Тетрис. Используется движком игр (brick_game) для
 * динамической регистрации и управления играми через единый API.
 *
 * @param[in] id Идентификатор запрашиваемой игры. Должен соответствовать
 * GAME_TETRIS для получения валидного интерфейса.
 *
 * @return Структура GameInterface_t, заполненная указателями на функции игры
 * Тетрис, если id == GAME_TETRIS. В противном случае возвращается пустая
 * структура (все поля — 0).
 *
 * @details
 * Заполненные поля при совпадении ID:
 * - id:        идентификатор игры (GAME_TETRIS)
 * - create:    указатель на tetris_create() — создание экземпляра
 * - destroy:   указатель на tetris_destroy() — освобождение ресурсов
 * - input:     указатель на tetris_handle_input() — обработка ввода
 * - update:    указатель на tetris_update() — игровой тик
 * - get_info:  указатель на tetris_get_info() — получение состояния для
 * отрисовки
 *
 * @note Функция потокобезопасна, если не используется совместно с изменением
 * GAME_TETRIS. Предназначена для вызова при инициализации игрового движка.
 *
 * @warning Не модифицируйте возвращаемую структуру. Поведение не определено,
 *          если переданный id не поддерживается игровым движком.
 *
 * @see GameInterface_t, GameId_t, tetris_create(), tetris_handle_input(),
 * s21_bgame.h
 */
GameInterface_t tetris_get_interface(GameId_t id);

#ifdef __cplusplus
}
#endif

#endif  // S21_TETRIS_H_